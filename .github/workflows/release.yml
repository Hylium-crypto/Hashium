name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake libevent-dev libboost-dev \
            libboost-filesystem-dev libboost-test-dev libsqlite3-dev \
            libminiupnpc-dev libnatpmp-dev libdb++-dev libzmq3-dev \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-l10n-tools \
            libgl1-mesa-dev libxkbcommon-dev libqrencode-dev

      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_WALLET=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_IPC=OFF
          cmake --build build -j$(nproc)

      - name: Package
        run: |
          mkdir -p "Hashium-${{ github.ref_name }}-Linux"
          cp build/bin/hashium-qt "Hashium-${{ github.ref_name }}-Linux/"
          cp build/bin/hashiumd "Hashium-${{ github.ref_name }}-Linux/"
          cp build/bin/hashium-cli "Hashium-${{ github.ref_name }}-Linux/"
          cp COPYING "Hashium-${{ github.ref_name }}-Linux/"
          cp README.md "Hashium-${{ github.ref_name }}-Linux/"
          tar -czvf "Hashium-${{ github.ref_name }}-Linux.tar.gz" "Hashium-${{ github.ref_name }}-Linux"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: Hashium-${{ github.ref_name }}-Linux.tar.gz

  build-macos:
    name: Build macOS
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake boost libevent sqlite miniupnpc libnatpmp berkeley-db@4 qt@6 qrencode

      - name: Build
        run: |
          export PATH="/opt/homebrew/opt/qt@6/bin:$PATH"
          export LDFLAGS="-L/opt/homebrew/opt/qt@6/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/qt@6/include"
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_WALLET=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_IPC=OFF \
            -DQt6_DIR=/opt/homebrew/opt/qt@6/lib/cmake/Qt6
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          mkdir -p "Hashium-${{ github.ref_name }}-macOS"
          cp build/bin/hashium-qt "Hashium-${{ github.ref_name }}-macOS/"
          cp build/bin/hashiumd "Hashium-${{ github.ref_name }}-macOS/"
          cp build/bin/hashium-cli "Hashium-${{ github.ref_name }}-macOS/"
          cp COPYING "Hashium-${{ github.ref_name }}-macOS/"
          cp README.md "Hashium-${{ github.ref_name }}-macOS/"
          tar -czvf "Hashium-${{ github.ref_name }}-macOS.tar.gz" "Hashium-${{ github.ref_name }}-macOS"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: Hashium-${{ github.ref_name }}-macOS.tar.gz

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-libevent
            mingw-w64-x86_64-sqlite3
            mingw-w64-x86_64-miniupnpc
            mingw-w64-x86_64-libnatpmp
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-qrencode
            mingw-w64-x86_64-db
            make
            git

      - name: Build
        run: |
          cmake -B build -G "MSYS Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_WALLET=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_IPC=OFF
          cmake --build build -j$(nproc)

      - name: Package
        shell: msys2 {0}
        run: |
          mkdir -p "Hashium-${{ github.ref_name }}-Windows"
          
          # Copy executables
          cp build/bin/*.exe "Hashium-${{ github.ref_name }}-Windows/"
          
          # Copy Qt6 DLLs
          cp /mingw64/bin/Qt6Core.dll "Hashium-${{ github.ref_name }}-Windows/"
          cp /mingw64/bin/Qt6Gui.dll "Hashium-${{ github.ref_name }}-Windows/"
          cp /mingw64/bin/Qt6Widgets.dll "Hashium-${{ github.ref_name }}-Windows/"
          cp /mingw64/bin/Qt6Network.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          
          # Copy Qt6 plugins
          mkdir -p "Hashium-${{ github.ref_name }}-Windows/platforms"
          cp /mingw64/share/qt6/plugins/platforms/qwindows.dll "Hashium-${{ github.ref_name }}-Windows/platforms/"
          
          mkdir -p "Hashium-${{ github.ref_name }}-Windows/styles"
          cp /mingw64/share/qt6/plugins/styles/*.dll "Hashium-${{ github.ref_name }}-Windows/styles/" || true
          
          # Copy other dependencies
          cp /mingw64/bin/libqrencode.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libevent*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libsqlite3*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libdb*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libminiupnpc*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libnatpmp*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          
          # Copy MinGW runtime DLLs
          cp /mingw64/bin/libgcc_s_seh-1.dll "Hashium-${{ github.ref_name }}-Windows/"
          cp /mingw64/bin/libstdc++-6.dll "Hashium-${{ github.ref_name }}-Windows/"
          cp /mingw64/bin/libwinpthread-1.dll "Hashium-${{ github.ref_name }}-Windows/"
          
          # Copy boost DLLs
          cp /mingw64/bin/libboost_filesystem*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libboost_thread*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          
          # Copy other required DLLs
          cp /mingw64/bin/zlib1.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libpng16-16.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libharfbuzz-0.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libfreetype-6.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libbz2-1.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libintl-8.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libiconv-2.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libpcre2-16-0.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libdouble-conversion.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libicuin*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libicuuc*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libicudt*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libbrotli*.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libglib-2.0-0.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libgraphite2.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libpcre2-8-0.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          cp /mingw64/bin/libmd4c.dll "Hashium-${{ github.ref_name }}-Windows/" || true
          
          # Copy docs
          cp COPYING "Hashium-${{ github.ref_name }}-Windows/"
          cp README.md "Hashium-${{ github.ref_name }}-Windows/"
          
          # Create ZIP
          7z a "Hashium-${{ github.ref_name }}-Windows.zip" "Hashium-${{ github.ref_name }}-Windows"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: Hashium-${{ github.ref_name }}-Windows.zip

  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true
          body: |
            # Hashium ${{ github.ref_name }}
            
            ‚ö†Ô∏è **Experimental cryptocurrency project - Not an investment**
            
            ## üì• Downloads
            
            | Platform | Download |
            |----------|----------|
            | **ü™ü Windows** (x64) | `Hashium-${{ github.ref_name }}-Windows.zip` |
            | **üçé macOS** (Apple Silicon) | `Hashium-${{ github.ref_name }}-macOS.tar.gz` |
            | **üêß Linux** (x86_64) | `Hashium-${{ github.ref_name }}-Linux.tar.gz` |
            
            ## üöÄ Quick Start
            
            ### Windows
            1. Download and extract the ZIP
            2. Run `hashium-qt.exe`
            
            ### macOS/Linux
            ```bash
            tar -xzf Hashium-*.tar.gz
            cd Hashium-*
            ./hashium-qt
            ```
            
            ### macOS Security Fix
            ```bash
            xattr -cr Hashium-*-macOS
            ```
            
            ## ‚ö†Ô∏è Disclaimer
            This is experimental software for educational purposes only.
            See [DISCLAIMER.md](https://github.com/Hylium-crypto/Hashium/blob/main/DISCLAIMER.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
