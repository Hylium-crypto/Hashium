name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake libevent-dev libboost-dev \
            libboost-filesystem-dev libboost-test-dev libsqlite3-dev \
            libminiupnpc-dev libnatpmp-dev libdb++-dev libzmq3-dev \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-l10n-tools \
            libgl1-mesa-dev libxkbcommon-dev libqrencode-dev

      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_WALLET=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_IPC=OFF
          cmake --build build -j$(nproc)

      - name: Package Linux App
        run: |
          mkdir -p "Hashium-${{ github.ref_name }}-Linux"
          cp build/bin/hashium-qt "Hashium-${{ github.ref_name }}-Linux/Hashium" 2>/dev/null || true
          cp build/bin/hashiumd "Hashium-${{ github.ref_name }}-Linux/"
          cp build/bin/hashium-cli "Hashium-${{ github.ref_name }}-Linux/"
          cp COPYING "Hashium-${{ github.ref_name }}-Linux/"
          cp README.md "Hashium-${{ github.ref_name }}-Linux/"
          
          # Create desktop file for Linux
          cat > "Hashium-${{ github.ref_name }}-Linux/Hashium.desktop" << EOF
          [Desktop Entry]
          Name=Hashium
          Comment=Hashium Wallet
          Exec=./Hashium
          Terminal=false
          Type=Application
          Categories=Finance;
          EOF
          
          chmod +x "Hashium-${{ github.ref_name }}-Linux/Hashium"
          tar -czvf "Hashium-${{ github.ref_name }}-Linux.tar.gz" "Hashium-${{ github.ref_name }}-Linux"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: Hashium-${{ github.ref_name }}-Linux.tar.gz

  build-macos:
    name: Build macOS App
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake boost libevent sqlite miniupnpc libnatpmp berkeley-db@4 qt@6 qrencode create-dmg

      - name: Build
        run: |
          export PATH="/opt/homebrew/opt/qt@6/bin:$PATH"
          export LDFLAGS="-L/opt/homebrew/opt/qt@6/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/qt@6/include"
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_WALLET=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_IPC=OFF \
            -DQt6_DIR=/opt/homebrew/opt/qt@6/lib/cmake/Qt6
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Create macOS App Bundle
        run: |
          export PATH="/opt/homebrew/opt/qt@6/bin:$PATH"
          QT_DIR="/opt/homebrew/opt/qt@6"
          APP="Hashium.app"
          
          # Create bundle structure
          mkdir -p "$APP/Contents/MacOS"
          mkdir -p "$APP/Contents/Resources"
          mkdir -p "$APP/Contents/Frameworks"
          mkdir -p "$APP/Contents/PlugIns/platforms"
          
          # Copy executables
          cp build/bin/hashium-qt "$APP/Contents/MacOS/Hashium"
          cp build/bin/hashiumd "$APP/Contents/MacOS/"
          cp build/bin/hashium-cli "$APP/Contents/MacOS/"
          chmod +x "$APP/Contents/MacOS/Hashium"
          
          # Create Info.plist using echo
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$APP/Contents/Info.plist"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$APP/Contents/Info.plist"
          echo '<plist version="1.0"><dict>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundleExecutable</key><string>Hashium</string>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundleIconFile</key><string>hashium.icns</string>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundleIdentifier</key><string>org.hashium.wallet</string>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundleName</key><string>Hashium</string>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundlePackageType</key><string>APPL</string>' >> "$APP/Contents/Info.plist"
          echo '<key>CFBundleVersion</key><string>1.4</string>' >> "$APP/Contents/Info.plist"
          echo '<key>LSMinimumSystemVersion</key><string>11.0</string>' >> "$APP/Contents/Info.plist"
          echo '<key>NSHighResolutionCapable</key><true/>' >> "$APP/Contents/Info.plist"
          echo '</dict></plist>' >> "$APP/Contents/Info.plist"
          
          # Copy icon
          cp src/qt/res/icons/hashium.icns "$APP/Contents/Resources/" 2>/dev/null || echo "No icon"
          
          # Run macdeployqt
          echo "Running macdeployqt..."
          macdeployqt "$APP" -executable="$APP/Contents/MacOS/hashiumd" -executable="$APP/Contents/MacOS/hashium-cli" -verbose=2
          
          # Verify and copy cocoa plugin if missing
          if [ ! -f "$APP/Contents/PlugIns/platforms/libqcocoa.dylib" ]; then
            echo "Copying cocoa plugin manually..."
            find "$QT_DIR" -name "libqcocoa.dylib" -exec cp {} "$APP/Contents/PlugIns/platforms/" \; 2>/dev/null || true
          fi
          
          # Create qt.conf
          echo '[Paths]' > "$APP/Contents/Resources/qt.conf"
          echo 'Plugins = PlugIns' >> "$APP/Contents/Resources/qt.conf"
          
          # Debug output
          echo "=== MacOS contents ===" && ls -la "$APP/Contents/MacOS/"
          echo "=== Frameworks ===" && ls -la "$APP/Contents/Frameworks/" 2>/dev/null || echo "none"
          echo "=== Plugins ===" && ls -la "$APP/Contents/PlugIns/platforms/" 2>/dev/null || echo "none"

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Hashium Wallet" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Hashium.app" 150 185 \
            --app-drop-link 450 185 \
            "Hashium-${{ github.ref_name }}-macOS.dmg" \
            "Hashium.app" || zip -r "Hashium-${{ github.ref_name }}-macOS.zip" Hashium.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            Hashium-${{ github.ref_name }}-macOS.dmg
            Hashium-${{ github.ref_name }}-macOS.zip


  # Windows build disabled temporarily - complex vcpkg dependency issues
  # Will be added in future release
  # build-windows:
  #   name: Build Windows App
  #   runs-on: windows-latest
  #   ...

  create-release:
    name: Create Release
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          generate_release_notes: true
          body: |
            # Hashium ${{ github.ref_name }}
            
            **ðŸ”’ Security â€¢ ðŸ’Ž Scarcity â€¢ ðŸ¦ Store of Value**
            
            ---
            
            ## ðŸ“¥ Downloads
            
            | Platform | Download | How to Install |
            |----------|----------|----------------|
            | **ðŸŽ macOS** | `Hashium-${{ github.ref_name }}-macOS.dmg` | Open DMG, drag to Applications |
            | **ðŸ§ Linux** | `Hashium-${{ github.ref_name }}-Linux.tar.gz` | Extract, run `./Hashium` |
            
            > ðŸªŸ Windows build coming soon!
            
            ---
            
            ## ðŸš€ Quick Start
            
            1. Download the file for your platform
            2. **macOS**: Open `.dmg`, drag Hashium to Applications, launch from Launchpad
            3. **Linux**: Extract `.tar.gz`, run `./Hashium`
            
            ---
            
            ## ðŸ’° Tokenomics
            - **Max Supply:** 21,000,000 HSM
            - **Block Reward:** 50 HSM
            - **Halving:** Every 210,000 blocks
            - **Smallest Unit:** 1 hashi = 0.00000001 HSM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
